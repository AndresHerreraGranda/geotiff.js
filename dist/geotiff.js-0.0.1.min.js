var GeoTIFF=function(){var a,b={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams"},c={};for(a in b)c[b[a]]=parseInt(a);var d=[c.BitsPerSample,c.ExtraSamples,c.SampleFormat,c.StripByteCounts,c.StripOffsets,c.StripRowCounts,c.TileByteCounts,c.TileOffsets],e={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},f={};for(a in e)f[e[a]]=parseInt(a);var g=function(a){var b;if("string"==typeof a||a instanceof String){b=new ArrayBuffer(2*a.length);for(var c=new Uint16Array(b),d=0,e=a.length;e>d;d++)c[d]=a.charCodeAt(d)}else{if(!(a instanceof ArrayBuffer))throw new Error("Invalid input data given.");b=a}return new h(b)},h=function(a){this.dataView=new DataView(a);var b=this.dataView.getUint16(0,0);if(18761===b)this.littleEndian=!0;else{if(19789!==b)throw new TypeError("Invalid byte order value.");this.littleEndian=!1}if(42!==this.dataView.getUint16(2,this.littleEndian))throw new TypeError("Invalid magic number.");this.fileDirectories=this.parseFileDirectories(this.dataView.getUint32(4,this.littleEndian))};h.prototype={getFieldTypeLength:function(a){switch(a){case f.BYTE:case f.ASCII:case f.SBYTE:case f.UNDEFINED:return 1;case f.SHORT:case f.SSHORT:return 2;case f.LONG:case f.SLONG:case f.FLOAT:return 4;case f.RATIONAL:case f.SRATIONAL:case f.DOUBLE:return 8;default:throw new RangeError("Invalid field type: "+a)}},getValues:function(a,b,c){var d,e=null,g=null,h=this.getFieldTypeLength(a);switch(a){case f.BYTE:case f.ASCII:case f.UNDEFINED:e=new Uint8Array(b),g=this.dataView.getUint8;break;case f.SBYTE:e=new Int8Array(b),g=this.dataView.getInt8;break;case f.SHORT:e=new Uint16Array(b),g=this.dataView.getUint16;break;case f.SSHORT:e=new Int16Array(b),g=this.dataView.getInt16;break;case f.LONG:e=new Uint32Array(b),g=this.dataView.getUint32;break;case f.SLONG:e=new Int32Array(b),g=this.dataView.getInt32;break;case f.RATIONAL:e=new Uint32Array(2*b),g=this.dataView.getUint32;break;case f.SRATIONAL:e=new Int32Array(2*b),g=this.dataView.getInt32;break;case f.FLOAT:e=new Float32Array(b),g=this.dataView.getFloat32;break;case f.DOUBLE:e=new Float64Array(b),g=this.dataView.getFloat64;break;default:throw new RangeError("Invalid field type: "+a)}if(a!==f.RATIONAL&&a!==f.SRATIONAL)for(d=0;b>d;++d)e[d]=g.call(this.dataView,c+d*h,this.littleEndian);else for(d=0;2*b>d;d+=2)e[d]=g.call(this.dataView,c+d*h,this.littleEndian),e[d+1]=g.call(this.dataView,c+(d+1)*h,this.littleEndian);return a===f.ASCII?String.fromCharCode.apply(null,e):e},getFieldValues:function(a,b,c,e){var g,h=this.getFieldTypeLength(b);if(4>=h*c)g=this.getValues(b,c,e);else{var i=this.dataView.getUint32(e,this.littleEndian);g=this.getValues(b,c,i)}return 1===c&&-1===d.indexOf(a)&&b!==f.RATIONAL&&b!==f.SRATIONAL?g[0]:g},parseFileDirectories:function(a){for(var c=a,d=[];0!==c;){for(var e=this.dataView.getUint16(c,this.littleEndian),f={},g=a+2,h=0;e>h;g+=12,++h){var i=this.dataView.getUint16(g,this.littleEndian),j=this.dataView.getUint16(g+2,this.littleEndian),k=this.dataView.getUint32(g+4,this.littleEndian);f[b[i]]=this.getFieldValues(i,j,k,g+8)}d.push(f),c=this.dataView.getUint32(g,this.littleEndian)}return d},getImage:function(a){var b=this.fileDirectories[a];if(!b)throw new RangeError("Invalid image index");return new i(b,this.dataView,this.littleEndian)}};var i=function(a,b,c){this.fileDirectory=a,this.dataView=b,this.littleEndian=c,this.tiles={},this.isTiled=a.StripOffsets?!1:!0;var d=a.PlanarConfiguration;if(this.planarConfiguration="undefined"==typeof d?1:d,1!==this.planarConfiguration&&2!==this.planarConfiguration)throw new Error("Invalid planar configuration.")};i.prototype={getWidth:function(){return this.fileDirectory.ImageWidth},getHeight:function(){return this.fileDirectory.ImageLength},getSamplesPerPixel:function(){return this.fileDirectory.SamplesPerPixel},getTileWidth:function(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()},getTileHeight:function(){return this.isTiled?this.fileDirectory.TileLength:this.fileDirectory.RowsPerStrip},getBytesPerPixel:function(){for(var a=0,b=0;b<this.fileDirectory.BitsPerSample.length;++b){var c=this.fileDirectory.BitsPerSample[b];if(c%8!==0)throw new Error("Sample bit-width of "+c+" is not supported.");if(c!==this.fileDirectory.BitsPerSample[0])throw new Error("Differing size of samples in a pixel are not supported.");a+=c}return a/8},getSampleByteSize:function(a){if(a>=this.fileDirectory.BitsPerSample.length)throw new RangeError("Sample index "+a+" is out of range.");var b=this.fileDirectory.BitsPerSample[a];if(b%8!==0)throw new Error("Sample bit-width of "+b+" is not supported.");return b/8},_getBlock:function(a,b,c){var d=this.dataView.buffer.slice(a,a+b);switch(this.fileDirectory.Compression){case 1:return new DataView(d);case 5:break;case 8:break;case 6:throw new Error("JPEG compression not supported.");case 32773:throw new Error("PackBits compression not supported.");default:throw new Error("Unknown compresseion method identifier: "+this.fileDirectory.Compression)}},getReaderForSample:function(a){var b=this.fileDirectory.SampleFormat[a],c=this.fileDirectory.BitsPerSample[a];switch(b){case 1:switch(c){case 8:return DataView.prototype.getUint8;case 16:return DataView.prototype.getUint16;case 32:return DataView.prototype.getUint32}break;case 2:switch(c){case 8:return DataView.prototype.getInt8;case 16:return DataView.prototype.getInt16;case 32:return DataView.prototype.getInt32}break;case 3:switch(c){case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}}},getArrayForSample:function(a,b){var c=this.fileDirectory.SampleFormat[a],d=this.fileDirectory.BitsPerSample[a];switch(c){case 1:switch(d){case 8:return new Uint8Array(b);case 16:return new Uint16Array(b);case 32:return new Uint32Array(b)}break;case 2:switch(d){case 8:return new Int8Array(b);case 16:return new Int16Array(b);case 32:return new Int32Array(b)}break;case 3:switch(d){case 32:return new Float32Array(b);case 64:return new Float64Array(b)}}throw Error("Unsupported data format/bitsPerSample")},getTileOrStrip:function(a,b,c){var d,e=Math.ceil(this.getWidth()/this.getTileWidth()),f=Math.ceil(this.getHeight()/this.getTileHeight());if(1===this.planarConfiguration?d=b*e+a:2===this.planarConfiguration&&(d=c*e*f+b*e+a),d in this.tiles,1){var g,h;return this.isTiled?(g=this.fileDirectory.TileOffsets[d],h=this.fileDirectory.TileByteCounts[d]):(g=this.fileDirectory.StripOffsets[d],h=this.fileDirectory.StripByteCounts[d]),this.tiles[d]=this._getBlock(g,h)}return this.tiles[d]},_readRaster:function(a,b,c){for(var d=this.getTileWidth(),e=this.getTileHeight(),f=Math.floor(a[0]/d),g=Math.ceil(a[2]/d),h=Math.floor(a[1]/e),i=Math.ceil(a[3]/e),k=(Math.ceil(this.getWidth()/d),a[2]-a[0]),l=(a[3]-a[1],this.getBytesPerPixel()),m=(this.getWidth(),[]),n=[],o=0;o<b.length;++o)1===this.planarConfiguration?m.push(j(this.fileDirectory.BitsPerSample,0,b[o])/8):m.push(0),n.push(this.getReaderForSample(b[o]));for(var p=h;i>=p;++p)for(var q=f;g>=q;++q)for(var r=p*e,s=q*d,t=(p+1)*e,u=(q+1)*d,v=0;v<b.length;++v){var w=b[v];2===this.planarConfiguration&&(l=this.getSampleByteSize(w));for(var x=this.getTileOrStrip(q,p,w),y=Math.max(0,a[1]-r);y<Math.min(e,e-(t-a[3]));++y)for(var z=Math.max(0,a[0]-s);z<Math.min(d,d-(u-a[2]));++z){var A=(y*d+z)*l,B=(y+r-a[1])*k+z+s-a[0];c[v][B]=n[v].call(x,A+m[v],this.littleEndian)}}},readRasters:function(a,b){if(a=a||[0,0,this.getWidth(),this.getHeight()],a[0]<0||a[1]<0||a[2]>this.getWidth()||a[3]>this.getHeight())throw new Error("Select window is out of image bounds.");if(a[0]>a[2]||a[1]>a[3])throw new Error("Invalid subsets");var c,d=a[2]-a[0],e=a[3]-a[1],f=d*e;if(!b)for(b=[],c=0;c<this.fileDirectory.SamplesPerPixel;++c)b.push(c);var g=[];for(c=0;c<b.length;++c)g.push(this.getArrayForSample(b[c],f));return this._readRaster(a,b,g),g}};var j=function(a,b,c){for(var d=0,e=b;c>e;++e)d+=a[e];return d};return{parse:g}}();